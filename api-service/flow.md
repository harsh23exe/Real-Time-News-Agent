
# API Service Flow

This document outlines the process for creating and integrating new API endpoints into the real-time news agent service.

## Overview

The API service is built with FastAPI and is responsible for handling user interactions, such as chat and queries related to the news articles stored in our database. It uses WebSockets for real-time communication with clients.

## Creating a New Endpoint

To add a new endpoint, follow these steps:

1.  **Define the Endpoint:** Create a new Python file in the `api-service` directory or add to an existing one. Define a new endpoint using FastAPI's decorators (`@app.get`, `@app.post`, `@app.websocket`).

2.  **Implement the Logic:** Write the business logic for your endpoint. This will typically involve:
    *   Receiving a user's query or message.
    *   Querying the Pinecone index to find relevant news articles.
    *   Using a language model to generate a response based on the user's query and the retrieved news articles.
    *   Sending the response back to the user.

3.  **Add Dependencies:** If your endpoint requires new dependencies, add them to the `api-service/requirements.txt` file.

---

## Best Practices for API Endpoints

- **Directory Structure:** Place all endpoint definitions in a dedicated directory (e.g., `api-service/routes/`) for clarity and maintainability.
- **Naming & Versioning:** Use RESTful naming and version your endpoints (e.g., `/api/v1/news/`).
- **Schemas:** Define request and response models using Pydantic. Document these in the code and in this README.
- **Error Handling:** Return errors in a consistent JSON format:
  ```json
  { "error": "InvalidRequest", "message": "Details about the error." }
  ```
- **Authentication:** If required, use JWT tokens in the `Authorization` header. Document the process for obtaining and using tokens.
- **Testing:** Write unit tests for each endpoint in `api-service/tests/` using FastAPI's `TestClient`.
- **Docs:** Keep the OpenAPI docs (auto-generated by FastAPI) up to date and share with frontend developers.
- **WebSockets:** Document the connection process, message format, and authentication for WebSocket endpoints.
- **Dependencies:** After adding new packages, update `requirements.txt` and notify the team.
- **Frontend Collaboration:** Before finalizing endpoints, confirm with frontend developers that the API meets their requirements.

---

## Example: Endpoint Documentation Template

Below is a template to document each endpoint. Please fill this out for every new endpoint you add.

### Endpoint: `/api/v1/news/search`

- **Method:** `POST`
- **Description:** Search for news articles based on a user query.
- **Request Body:**
  ```json
  {
    "query": "string",
    "limit": 10
  }
  ```
- **Response:**
  ```json
  {
    "results": [
      {
        "title": "string",
        "url": "string",
        "summary": "string",
        "published_at": "ISO8601 timestamp"
      }
    ]
  }
  ```
- **Errors:**
  - `400 Bad Request`: Invalid input
  - `500 Internal Server Error`: Unexpected failure
- **Authentication:** Requires JWT in `Authorization` header
- **Test Cases:**
  - Valid query returns results
  - Invalid query returns 400

---

## WebSocket Endpoint Example

### Endpoint: `/ws/chat`
- **Description:** Real-time chat for user queries and responses.
- **Connection:**
  - URL: `ws://<host>/ws/chat`
  - Authentication: JWT token as query param or header
- **Message Format:**
  ```json
  {
    "type": "user_message",
    "content": "string"
  }
  ```
- **Response Format:**
  ```json
  {
    "type": "bot_response",
    "content": "string"
  }
  ```
- **Error Handling:**
  - On error, send message with `{ "type": "error", "message": "Details" }`

---

**Note:** Always communicate with frontend developers to confirm the request/response structure and error handling before finalizing endpoints.

